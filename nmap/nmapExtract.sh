#!/bin/bash
usage="$0 -p [PORT] -f [FILE] [-c (for comma separated)]"

if [ $# -lt 2 ]; then
  echo $usage
  exit 1
fi

comma=false

while getopts ":p:f:hc" opt; do
  case ${opt} in
    h )
      echo $usage
      exit 0
      ;;
    p )
      port=${OPTARG}
      ;;
    f )
      file=${OPTARG}
      ;;
    c )
      comma=true
      ;;
    \? )
      echo "Invalid option: -$OPTARG" 1>&2
      exit 1
      ;;
    : )
      echo "Option -$OPTARG requires an argument" 1>&2
      exit 1
      ;;
  esac
done

if [ -v file ]; then
  if [ -v port ]; then
    if [ "$comma" = false ]; then
      cat $file | grep " $port/open" | cut -d ' ' -f2
    else
      cat $file | grep " $port/open" | cut -d ' ' -f2 | tr "\n" "," | sed 's/,$//'
    fi
  else
    ports=$(cat $file | grep "open" | cut -d ":" -f3 | tr " " "\n" | grep "open" | cut -d "/" -f1 | sort -nu)

    for x in $ports
      do
      data=$(cat $file | grep " $x/open" | cut -d ' ' -f2)
      if [[ $(echo -e "$data" | wc -c) -ge 2 ]]
        then
        echo -e "\n# $x\n$data"
      fi
    done
    exit 0
  fi
else
  echo $usage
fi