import sys
import xml.etree.ElementTree as ET

if len(sys.argv) < 2:
    print('Usage: python3 getPorts.py <input_file>')
    sys.exit(1)

input_file = sys.argv[1]

# Parse the Nmap XML file and get all host elements
tree = ET.parse(input_file)
root = tree.getroot()
hosts = root.findall('.//host')

# Create a dictionary to store open ports and corresponding hosts
open_ports = {}

# Loop through each host and its ports
for host in hosts:
    ip_addr = host.find('.//address').attrib['addr']  # Get IP address of host
    ports = host.findall('.//port')

    # Loop through each port and add it to the open_ports dictionary if it's open
    for port in ports:
        port_num = int(port.attrib['portid'])
        state = port.find('.//state').attrib['state']
        if state == 'open':
            if port_num not in open_ports:
                open_ports[port_num] = []
            open_ports[port_num].append(ip_addr)

# Print the open ports and their corresponding hosts
for port in sorted(open_ports):
    print(f"# Port: {port}")
    print('\n'.join(open_ports[port]))
    print('')
